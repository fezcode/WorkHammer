<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:WorkHammer.ViewModels"
             xmlns:ui="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
             xmlns:conv="using:WorkHammer.Views.Converters"
             xmlns:views="using:WorkHammer.Views"
             x:Class="WorkHammer.Views.Controls.JobDetailView"
             x:DataType="vm:MainWindowViewModel">

    <UserControl.Resources>
        <conv:StatusToColorConverter x:Key="StatusColorConverter"/>
        <conv:StatusToIconConverter x:Key="StatusIconConverter"/>
    </UserControl.Resources>

    <Grid RowSpan="2" RowDefinitions="Auto,*" IsVisible="{Binding !IsEditing}">
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,40">
            <StackPanel Spacing="6">
                <TextBlock Text="{Binding SelectedJob.Company}" FontSize="36" FontWeight="SemiLight" Foreground="White"/>
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="{Binding SelectedJob.Role}" FontSize="20" Foreground="#CCCCCC"/>
                    <Border Background="{Binding SelectedJob.Status, Converter={StaticResource StatusColorConverter}}" CornerRadius="14" Padding="12,4" VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <ui:SymbolIcon Symbol="{Binding SelectedJob.Status, Converter={StaticResource StatusIconConverter}}" FontSize="14" Foreground="White" x:CompileBindings="False"/><TextBlock Text="{Binding SelectedJob.Status}" FontSize="12" Foreground="White" FontWeight="SemiBold"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </StackPanel>
            <Button Grid.Column="1" Command="{Binding EditCurrentCommand}" Classes="accent" VerticalAlignment="Top">
                <StackPanel Orientation="Horizontal" Spacing="8"><ui:SymbolIcon Symbol="Edit" FontSize="16" x:CompileBindings="False" Foreground="Black"/><TextBlock Text="Edit Application" Foreground="Black"/></StackPanel>
            </Button>
        </Grid>
        <ScrollViewer Grid.Row="1">
            <StackPanel Spacing="40">
                <Grid ColumnDefinitions="*,*,*,*">
                    <StackPanel Grid.Column="0" Spacing="8"><TextBlock Text="DATE APPLIED" Classes="section-header"/><TextBlock Text="{Binding SelectedJob.AppliedDate, StringFormat='{}{0:D}'}" FontSize="16"/></StackPanel>
                    <StackPanel Grid.Column="1" Spacing="8"><TextBlock Text="DATE CREATED" Classes="section-header"/><TextBlock Text="{Binding SelectedJob.CreatedDate, StringFormat='{}{0:D}'}" FontSize="16"/></StackPanel>
                    <StackPanel Grid.Column="2" Spacing="8"><TextBlock Text="LAST UPDATED" Classes="section-header"/><TextBlock Text="{Binding SelectedJob.UpdatedDate, FallbackValue='Never'}" FontSize="16" Opacity="0.6"/></StackPanel>
                    <StackPanel Grid.Column="3" Spacing="8">
                        <TextBlock Text="JOB LINK" Classes="section-header"/>
                        <Button Content="Open Link" 
                                Command="{Binding OpenUrlCommand}"
                                CommandParameter="{Binding SelectedJob.Link}"
                                Classes="toolbar-link"
                                ToolTip.Tip="{Binding SelectedJob.Link}"
                                IsVisible="{Binding SelectedJob.Link, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                FontSize="16"/>
                        <TextBlock Text="No Link" IsVisible="{Binding SelectedJob.Link, Converter={x:Static StringConverters.IsNullOrEmpty}}" 
                                 FontSize="16" Opacity="0.4"/>
                    </StackPanel>
                </Grid>
                
                <StackPanel Spacing="12">
                    <TextBlock Text="DESCRIPTION" Classes="section-header"/>
                    <TextBlock views:Linker.Text="{Binding SelectedJob.Description}" FontSize="14" TextWrapping="Wrap" LineHeight="22" Opacity="0.9"/>
                </StackPanel>
                <StackPanel Spacing="12"><TextBlock Text="TECH STACK" Classes="section-header"/><ItemsControl ItemsSource="{Binding SelectedJob.TechStack}"><ItemsControl.ItemsPanel><ItemsPanelTemplate><WrapPanel/></ItemsPanelTemplate></ItemsControl.ItemsPanel><ItemsControl.ItemTemplate><DataTemplate><Border Classes="tech-badge"><TextBlock Text="{Binding}" FontSize="12"/></Border></DataTemplate></ItemsControl.ItemTemplate></ItemsControl></StackPanel>
                
                <StackPanel Spacing="12">
                    <TextBlock Text="STAGES" Classes="section-header"/>
                    <ItemsControl ItemsSource="{Binding SelectedJob.Stages}">
                        <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel Spacing="8"/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#10FFFFFF" CornerRadius="4" Padding="12,8">
                                    <TextBlock Text="{Binding}" FontSize="13"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <StackPanel Spacing="12">
                    <TextBlock Text="APPLICATION RESULT" Classes="section-header"/>
                    <Border Background="#15FFFFFF" BorderBrush="#30FFFFFF" BorderThickness="1" CornerRadius="8" Padding="20">
                        <StackPanel Spacing="10">
                            <Grid ColumnDefinitions="Auto, *">
                                <TextBlock Text="Stage reached:" FontSize="12" Opacity="0.6" Margin="0,0,10,0"/>
                                <TextBlock Grid.Column="1" Text="{Binding SelectedJob.Result.Stage, FallbackValue='N/A'}" FontWeight="SemiBold"/>
                            </Grid>
                            <TextBlock Text="Reason / Feedback:" FontSize="12" Opacity="0.6"/>
                            <TextBlock views:Linker.Text="{Binding SelectedJob.Result.Reason, FallbackValue='No feedback provided'}" TextWrapping="Wrap" Opacity="0.9"/>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <StackPanel Spacing="12">
                    <TextBlock Text="APPLICATION LOGS" Classes="section-header"/>
                    <ItemsControl ItemsSource="{Binding SelectedJob.Logs}">
                        <ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel Spacing="10"/></ItemsPanelTemplate></ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#08FFFFFF" BorderBrush="#15FFFFFF" BorderThickness="1" CornerRadius="6" Padding="12">
                                    <Grid ColumnDefinitions="Auto, *, Auto">
                                        <TextBlock Text="{Binding Date, StringFormat='{}{0:d}'}" FontSize="11" Opacity="0.5" VerticalAlignment="Top"/>
                                        <StackPanel Grid.Column="1" Margin="15,0,0,0">
                                            <TextBlock Text="{Binding Stage}" IsVisible="{Binding Stage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" 
                                                       FontSize="12" FontWeight="Bold" Foreground="SkyBlue" Margin="0,0,0,4"/>
                                            <TextBlock views:Linker.Text="{Binding Text}" TextWrapping="Wrap" FontSize="13" Opacity="0.9"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <TextBlock Text="No logs recorded yet." IsVisible="{Binding !SelectedJob.Logs.Count}" Opacity="0.3" FontSize="12" HorizontalAlignment="Center" Margin="0,10,0,0"/>
                </StackPanel>

                <StackPanel Spacing="12">
                    <TextBlock Text="PERSONAL NOTES" Classes="section-header"/>
                    <Border Background="#10FFFFFF" CornerRadius="8" Padding="20">
                        <TextBlock views:Linker.Text="{Binding SelectedJob.Notes}" FontSize="14" TextWrapping="Wrap" Opacity="0.8" FontStyle="Italic"/>
                    </Border>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
