<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:WorkHammer.ViewModels"
             xmlns:models="using:WorkHammer.Models"
             xmlns:ui="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
             xmlns:conv="using:WorkHammer.Views.Converters"
             x:Class="WorkHammer.Views.Controls.SidebarView"
             x:DataType="vm:MainWindowViewModel">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <UserControl.Resources>
        <conv:StatusToColorConverter x:Key="StatusColorConverter"/>
        <conv:StatusToPathConverter x:Key="StatusPathConverter"/>
        <conv:PathTruncateConverter x:Key="PathTruncateConverter"/>
    </UserControl.Resources>

    <Border Background="#15000000" BorderBrush="#30FFFFFF" BorderThickness="0,0,1,0">
        <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,*">
            
            <!-- Sidebar Actions -->
            <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="16,15,16,10">
                <TextBlock Text="APPLICATIONS" Classes="section-header" VerticalAlignment="Center"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                    <Button Command="{Binding AddJobCommand}" Classes="toolbar" ToolTip.Tip="New Application">
                        <PathIcon Data="{StaticResource IconPlus}" Width="16" Height="16" Foreground="#888888"/>
                    </Button>
                    
                    <!-- Sort Button -->
                    <Button Classes="toolbar" ToolTip.Tip="Sort Applications">
                        <Button.Flyout>
                            <MenuFlyout>
                                <MenuItem Header="Sort by Name" Command="{Binding SetSortCommand}" CommandParameter="{x:Static vm:JobSortOption.Name}">
                                    <MenuItem.Icon>
                                        <PathIcon Data="{Binding SortDirectionIcon}" Width="10" Height="10" Foreground="SkyBlue" IsVisible="{Binding IsNameSortActive}"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Sort by Status" Command="{Binding SetSortCommand}" CommandParameter="{x:Static vm:JobSortOption.Status}">
                                    <MenuItem.Icon>
                                        <PathIcon Data="{Binding SortDirectionIcon}" Width="10" Height="10" Foreground="SkyBlue" IsVisible="{Binding IsStatusSortActive}"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Sort by Date Applied" Command="{Binding SetSortCommand}" CommandParameter="{x:Static vm:JobSortOption.DateApplied}">
                                    <MenuItem.Icon>
                                        <PathIcon Data="{Binding SortDirectionIcon}" Width="10" Height="10" Foreground="SkyBlue" IsVisible="{Binding IsDateSortActive}"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Sort by Last Update" Command="{Binding SetSortCommand}" CommandParameter="{x:Static vm:JobSortOption.LastUpdate}">
                                    <MenuItem.Icon>
                                        <PathIcon Data="{Binding SortDirectionIcon}" Width="10" Height="10" Foreground="SkyBlue" IsVisible="{Binding IsUpdateSortActive}"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Sort by Creation Date" Command="{Binding SetSortCommand}" CommandParameter="{x:Static vm:JobSortOption.CreatedDate}">
                                    <MenuItem.Icon>
                                        <PathIcon Data="{Binding SortDirectionIcon}" Width="10" Height="10" Foreground="SkyBlue" IsVisible="{Binding IsCreatedSortActive}"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                            </MenuFlyout>
                        </Button.Flyout>
                        <PathIcon Data="{StaticResource IconSort}" Width="14" Height="14" Foreground="#888888"/>
                    </Button>

                    <Button Command="{Binding OpenExplorerCommand}" Classes="toolbar" ToolTip.Tip="Reveal in File Explorer">
                        <PathIcon Data="{StaticResource IconSearch}" Width="14" Height="14" Foreground="#888888"/>
                    </Button>
                    <Button Click="OnSelectFolderClicked" Classes="toolbar" ToolTip.Tip="Change Working Folder">
                        <PathIcon Data="{StaticResource IconFolder}" Width="14" Height="14" Foreground="#888888"/>
                    </Button>
                </StackPanel>
            </Grid>
            
             <TextBlock Grid.Row="1" Text="{Binding CurrentDataPath, Converter={StaticResource PathTruncateConverter}, ConverterParameter=30}" 
                       FontSize="10" Foreground="#AAAAAA" Margin="16,0,16,12" Background="Transparent"
                       ToolTip.Tip="{Binding CurrentDataPath}" ToolTip.Placement="Bottom" ToolTip.VerticalOffset="5" ToolTip.ShowDelay="500"
                       IsVisible="{Binding CurrentDataPath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

            <Border Grid.Row="2" Height="1" Background="#20FFFFFF" Margin="0,0,0,12"/>

            <!-- Search & Filter -->
            <Grid Grid.Row="3" Margin="16,0,16,15" RowDefinitions="Auto,Auto">
                <TextBox Grid.Row="0" Text="{Binding SearchText}" Watermark="Search..." Height="32" Padding="8,4" FontSize="12" Margin="0,0,0,8" Foreground="White"/>
                <Grid Grid.Row="1" ColumnDefinitions="*,Auto">
                    <ComboBox Grid.Column="0" ItemsSource="{Binding JobStatuses}" SelectedItem="{Binding StatusFilter}" PlaceholderText="Filter by Status"
                              HorizontalAlignment="Stretch" Height="32" Padding="8,8" FontSize="11">
                              <ComboBox.ItemTemplate>
                                <DataTemplate><TextBlock Text="{Binding}" FontSize="11" Foreground="White"/></DataTemplate>
                              </ComboBox.ItemTemplate>
                    </ComboBox>
                    <Button Grid.Column="1" Classes="toolbar" Margin="6,0,0,0" Command="{Binding ClearFilterCommand}" IsVisible="{Binding StatusFilter, Converter={x:Static ObjectConverters.IsNotNull}}" ToolTip.Tip="Clear Filter">
                        <PathIcon Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" Width="12" Height="12" Foreground="White"/>
                    </Button>
                </Grid>
            </Grid>
            
            <Border Grid.Row="4" Height="1" Background="#20FFFFFF" Margin="0,0,0,5"/>

            <ListBox Grid.Row="5" ItemsSource="{Binding Jobs}" SelectedItem="{Binding SelectedJob}" Background="Transparent" BorderThickness="0" Margin="0">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Background="Transparent" HorizontalAlignment="Stretch" Padding="12,10">
                            <Border.ContextFlyout>
                                <MenuFlyout>
                                    <MenuItem Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).EditCurrentCommand}">
                                        <MenuItem.Header>
                                            <StackPanel Orientation="Horizontal">
                                                <PathIcon Data="{StaticResource IconPencil}" Classes="menu-icon"/>
                                                <TextBlock Text="Edit Application" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <Separator/>
                                    <MenuItem Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).DeleteJobCommand}"
                                              Classes="danger">
                                        <MenuItem.Header>
                                            <StackPanel Orientation="Horizontal">
                                                <PathIcon Data="{StaticResource IconTrash}" Classes="menu-icon"/>
                                                <TextBlock Text="Delete Application" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </MenuItem.Header>
                                    </MenuItem>
                                </MenuFlyout>
                            </Border.ContextFlyout>
                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" Background="Transparent">
                                <!-- Status Indicator -->
                                <PathIcon Grid.RowSpan="2" Grid.Column="0" 
                                          Data="{Binding Status, Converter={StaticResource StatusPathConverter}}" 
                                          Width="14" Height="14" Margin="0,0,12,0" VerticalAlignment="Center"
                                          Foreground="{Binding Status, Converter={StaticResource StatusColorConverter}}"/>

                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding Company}" FontSize="13" Foreground="White" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Role}" FontSize="11" Foreground="#CCCCCC" TextTrimming="CharacterEllipsis"/>
                                <Ellipse Grid.Row="1" Grid.Column="1" Width="6" Height="6" Fill="Orange" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,0,2" IsVisible="{Binding IsDirty}"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Grid>
    </Border>
</UserControl>
